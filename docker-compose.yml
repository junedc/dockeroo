
version: "3.9"
services:
  starline-api-app:
    build:
      context: .
      dockerfile: docker/laravel/Dockerfile
    container_name: starline-api-app
    working_dir: /var/www/html
    ports: ["9003:9003"]
    volumes:
      - ../starline-api:/var/www/html
      - ./docker/laravel/php.ini:/usr/local/etc/php/conf.d/custom.ini
      - ./docker/laravel/xdebug.ini:/usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini
    depends_on: [mysql, redis, meilisearch, mailhog]
    extra_hosts: ["host.docker.internal:host-gateway"]
    networks: [starline-net]

  starline-api-nginx:
    image: nginx:alpine
    container_name: starline-api-nginx
    ports: ["${LARAVEL_HTTP_PORT:-8000}:80"]
    volumes:
      - ../starline-api:/var/www/html
      - ./docker/nginx/starline-api.conf:/etc/nginx/conf.d/default.conf
    depends_on: [starline-api-app]
    networks: [starline-net]

  mysql:
    image: mysql:8.0
    container_name: starline-mysql
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE:-starline}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
      MYSQL_USER: ${MYSQL_USER:-starline}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-starline123}
    ports: ["${MYSQL_PORT:-3307}:3306"]
    volumes: [mysql_data:/var/lib/mysql]
    networks: [starline-net]

  redis:
    image: redis:7-alpine
    container_name: starline-redis
    restart: unless-stopped
    ports: ["${REDIS_PORT:-6380}:6379"]
    volumes: [redis_data:/data]
    networks: [starline-net]

  meilisearch:
    image: getmeili/meilisearch:latest
    container_name: starline-meilisearch
    restart: unless-stopped
    environment:
      MEILI_ENV: development
      MEILI_MASTER_KEY: ${MEILISEARCH_KEY:-masterKey123}
      MEILI_NO_ANALYTICS: "true"
    ports: ["${MEILISEARCH_PORT:-7701}:7700"]
    volumes: [meili_data:/meili_data]
    networks: [starline-net]

  mailhog:
    image: mailhog/mailhog:latest
    container_name: starline-mailhog
    restart: unless-stopped
    ports:
      - "${MAILHOG_SMTP_PORT:-1026}:1025"
      - "${MAILHOG_UI_PORT:-8026}:8025"
    networks: [starline-net]

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: starline-phpmyadmin
    restart: unless-stopped
    depends_on: [mysql]
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
    ports: ["${PHPMYADMIN_PORT:-8082}:80"]
    networks: [starline-net]

  admin-ui:
    image: node:22-alpine
    container_name: admin-ui
    working_dir: /app
    ports: ["${ADMIN_UI_PORT:-5173}:5173"]
    volumes:
      - ../admin-ui:/app
      - admin_ui_node_modules:/app/node_modules
    environment: { CHOKIDAR_USEPOLLING: "true" }
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0 --port 5173"
    networks: [starline-net]

  ordering-portal-develop:
    image: node:22-alpine
    container_name: ordering-portal-develop
    working_dir: /app
    ports: ["${ORDERING_DEV_PORT:-5174}:5174"]
    volumes:
      - ../ordering-portal-develop:/app
      - ordering_dev_node_modules:/app/node_modules
      - ordering_dev_pnpm_store:/pnpm/store  
    environment:
      CHOKIDAR_USEPOLLING: "true"
      PNPM_HOME: /pnpm
    command: sh -c "corepack enable && pnpm config set store-dir /pnpm/store && pnpm install && pnpm run dev --host 0.0.0.0 --port 5174"
    networks: [starline-net]

  ordering-portal-master:
    image: node:16-alpine
    container_name: ordering-portal-master
    working_dir: /app
    ports: ["${ORDERING_MASTER_PORT:-5175}:5175"]
    volumes:
      - ../ordering-portal-master:/app
      - ordering_master_node_modules:/app/node_modules
    environment: { CHOKIDAR_USEPOLLING: "true" }
    command: sh -c "npm install --legacy-peer-deps && npm run serve -- --host 0.0.0.0 --port 5175"
    networks: [starline-net]

volumes:
  mysql_data:
  redis_data:
  meili_data:
  admin_ui_node_modules:
  ordering_dev_node_modules:
  ordering_dev_pnpm_store:
  ordering_master_node_modules:

networks:
  starline-net:
    driver: bridge
